#!/usr/bin/env bash

set -euo 'pipefail'

mount-drive() {
    udisksctl mount -b "$(wait-for-dev -s)" --no-user-interaction \
        | grep 'Mounted' \
        | awk '{print $4}'
}

cd "$DOTS_DIR/lib/kbd"

trash -v firmware/*

make

cd firmware

echo 'Connect the left side keyboard to USB.'

mount_point=$(mount-drive)

echo 'Press Mod + Macro1'

cp -v ./*left*.uf2 "$mount_point"

echo 'Power off both keyboards (by unplugging them and making sure the switches are off).'
echo 'Turn on the left side keyboard with the switch.'
echo 'Connect the right side keyboard to USB to power it on.'

mount_point=$(mount-drive)

echo 'Press Mod + Macro3'

cp -v ./*right*.uf2 "$mount_point"

echo 'Unplug the right side keyboard and turn it back on.'
