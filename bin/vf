#!/usr/bin/env sh
# Select and edit a desired file

set -e

dir=.
files_cmd='find . -type f'

while getopts 'd:g' opt; do
  case ${opt} in
    d)
        dir="${OPTARG}"
        ;;
    g)
        files_cmd='git ls-files --others --cached --exclude-standard'
        ;;
    ?)
      echo "Invalid option: -${OPTARG}."
      exit 1
      ;;
  esac
done

shift $((OPTIND - 1))
query="$1"

cd "$dir"

files=$($files_cmd)

[ -n "$query" ] && files=$(echo "$files" | grep "$query")

selected=$(echo "$files" | sed 's|^./||' | fzf --preview "bat --color=always {}" \
    --preview-window "~3" \
    --select-1)

[ -n "$selected" ] && "$EDITOR" "$selected"
