#!/usr/bin/env sh
# Watch for plugged in drives
# Pass -s parameter to get first one and exit

stdbuf -oL -- udevadm monitor --udev -s block | while read -r -- _ _ event devpath _; do
    if [ "$event" = add ]; then
        devname=$(udevadm info -p /sys/"$devpath" | awk -v FS== '/DEVNAME/ {print $2}')
        if lsblk -o PATH,TYPE | grep 'disk' | grep -q "$devname "; then
            echo "$devname"
            if [ "$1" = '-s' ]; then
                pkill -P $$ udevadm
                exec true
            fi
        fi
    fi
done
